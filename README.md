# WB Automation

API для автоматизации работы с Wildberries: загрузка продуктов, синхронизация цен, получение актуальной информации.

## Архитектура

Проект использует FastAPI, PostgreSQL, Redis и Celery для фоновых задач. Все сервисы запускаются через Docker Compose.

## Последние цены (Latest Prices)

### SQL VIEW: v_products_latest_price

Для эффективного получения последней цены каждого продукта используется SQL VIEW `v_products_latest_price`. 

**Что это такое:**
VIEW автоматически выбирает самую свежую запись из таблицы `price_snapshots` для каждого `nm_id`, используя `DISTINCT ON` для оптимизации производительности.

**Зачем нужна:**
- Избегает необходимости хранить текущую цену в таблице `products` (нормализация данных)
- Обеспечивает актуальность данных без дополнительных обновлений
- Упрощает запросы для получения последних цен

**Как обновляется:**
VIEW создаётся и обновляется через Alembic миграции. При добавлении новых записей в `price_snapshots` VIEW автоматически отражает последние значения. Для изменения структуры VIEW необходимо создать новую миграцию.

**Структура VIEW:**
- `nm_id` - идентификатор товара
- `wb_price` - цена Wildberries
- `wb_discount` - скидка (%)
- `spp` - дополнительная скидка (%)
- `customer_price` - итоговая цена для покупателя
- `rrc` - рекомендованная розничная цена
- `price_at` - время создания снимка цены

## API Endpoints

### Получение последних цен

```bash
# Получить последние цены (с пагинацией)
curl "http://localhost:8000/api/v1/prices/latest?limit=50&offset=0"
```

Возвращает список последних цен для всех продуктов, отсортированный по `nm_id`.

### Получение продуктов с последними ценами

```bash
# Получить продукты с их последними ценами
curl "http://localhost:8000/api/v1/products/with-latest-price?limit=50&offset=0"
```

Возвращает объединённые данные из таблиц `products` и `v_products_latest_price`, включая информацию о продукте и его последней цене.

## Запуск

```bash
docker compose up -d
docker compose exec api alembic upgrade head
```

## Миграции

Все изменения схемы БД выполняются через Alembic миграции:

```bash
docker compose exec api alembic upgrade head
```

