name: ecomcore

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: wb
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: wb
    # Load environment variables from root .env file (D:\Work\EcomCore\.env)
    # This file must contain: POSTGRES_PASSWORD, BOOTSTRAP_ADMIN, etc.
    env_file: ../../.env
    networks:
      - ecomcore-network
    volumes:
      # Persistent volume для данных PostgreSQL
      # Без этого volume данные теряются при docker compose down
      - postgres_data:/var/lib/postgresql/data
    # Не публикуем порт наружу
    expose:
      - "5432"

  redis:
    image: redis:7
    # Не публикуем порт наружу
    expose:
      - "6379"
    networks:
      - ecomcore-network

  api:
    build:
        context: ../../
        dockerfile: Dockerfile
    # Load environment variables from root .env file (D:\Work\EcomCore\.env)
    # Required vars: POSTGRES_PASSWORD
    # Optional vars: BOOTSTRAP_ADMIN, BOOTSTRAP_ADMIN_USERNAME, BOOTSTRAP_ADMIN_PASSWORD, BOOTSTRAP_ADMIN_EMAIL
    env_file: ../../.env
    environment:
      - PYTHONPATH=/app/src
      # Bootstrap admin user on startup (only if users table is empty)
      # Set BOOTSTRAP_ADMIN=1 in .env to enable, along with BOOTSTRAP_ADMIN_USERNAME, BOOTSTRAP_ADMIN_PASSWORD, BOOTSTRAP_ADMIN_EMAIL
      # Default: disabled (0) for security
      - BOOTSTRAP_ADMIN=${BOOTSTRAP_ADMIN:-0}
      - BOOTSTRAP_ADMIN_USERNAME=${BOOTSTRAP_ADMIN_USERNAME:-admin}
      - BOOTSTRAP_ADMIN_PASSWORD=${BOOTSTRAP_ADMIN_PASSWORD:-}
      - BOOTSTRAP_ADMIN_EMAIL=${BOOTSTRAP_ADMIN_EMAIL:-admin@local.dev}
    volumes:
      # Windows Docker Desktop fix: use relative path from compose file location
      # Docker Desktop on Windows has issues with absolute paths like D:\Work\EcomCore
      # Using relative paths (../../) avoids the /run/desktop/mnt/host/d creation issue
      # Note: Docker Desktop may still resolve this to absolute path, causing mount issues
      # If you see "mkdir /run/desktop/mnt/host/d: file exists" error, restart Docker Desktop
      - ../../:/app:cached
      # test.xml уже доступен через основной volume ../../:/app, отдельное монтирование не требуется
    # Entrypoint waits for PostgreSQL, runs migrations (with advisory lock protection), then starts uvicorn
    entrypoint: ["python", "/app/scripts/docker-entrypoint.py"]
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --app-dir /app/src
    depends_on:
      - postgres
    # Публикуем порт для прямого доступа к API (удобно для разработки)
    ports:
      - "8000:8000"
    expose:
      - "8000"
    dns:
      - 1.1.1.1
      - 8.8.8.8
    networks:
      - ecomcore-network

  worker:
      build:
        context: ../../
        dockerfile: Dockerfile
      # Load environment variables from root .env file
      env_file: ../../.env
      environment:
        - PYTHONPATH=/app/src
      volumes:
        # Windows Docker Desktop fix: use relative path from compose file location
        - ../../:/app:cached
      command: celery -A app.celery_app worker -l info
      depends_on:
        - redis
        - postgres
      networks:
        - ecomcore-network

  beat:
      build:
        context: ../../
        dockerfile: Dockerfile
      # Load environment variables from root .env file
      env_file: ../../.env
      environment:
        - PYTHONPATH=/app/src
      volumes:
        # Windows Docker Desktop fix: use relative path from compose file location
        - ../../:/app:cached
      command: celery -A app.celery_app beat -l info
      depends_on:
        - redis
        - postgres
      networks:
        - ecomcore-network

  adminer:
    image: adminer
    restart: always
    # Не публикуем порт наружу
    expose:
      - "8080"
    ports:
    - "8080:8080"
    depends_on:
      - postgres
    networks:
      - ecomcore-network

  frontend:
    build:
      context: ../../frontend
      dockerfile: Dockerfile.dev  # Используем dev версию для локальной разработки
    environment:
      - NEXT_PUBLIC_API_BASE=
      - NEXT_PUBLIC_API_URL=http://api:8000/api  # URL для rewrites в Next.js (внутренний Docker)
      - NODE_ENV=development
      - HOSTNAME=0.0.0.0  # Явно указываем, что Next.js должен слушать на всех интерфейсах
      - PORT=3000
    volumes:
      # Windows Docker Desktop fix: use relative path from compose file location
      - ../../frontend:/app:cached
      - /app/node_modules  # Изолируем node_modules от хоста
      - /app/.next  # Изолируем .next от хоста
    ports:
      - "3000:3000"  # Публикуем порт для прямого доступа
    expose:
      - "3000"
    depends_on:
      - api
    command: npm run dev  # Явно указываем dev режим
    networks:
      - ecomcore-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      # Windows Docker Desktop fix: use relative path from compose file location
      # Note: If nginx fails to start with mount error, try restarting Docker Desktop
      - ../../nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../../nginx/.htpasswd:/etc/nginx/.htpasswd:ro
    depends_on:
      - frontend
      - api
      - adminer
    restart: unless-stopped
    networks:
      - ecomcore-network

volumes:
  postgres_data:
    driver: local

networks:
  ecomcore-network:
    driver: bridge
